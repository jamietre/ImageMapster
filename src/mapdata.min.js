/* mapdata.js
   the MapData object, repesents an instance of a single bound imagemap
*/
(function(a){var c,b=a.mapster,d=b.utils;b.MapData=function(e,g){var f=this;function h(l,i,j){function k(m){if(f.currentAreaId!==m&&f.highlightId>=0){j();
}}if(f.activeAreaEvent){window.clearTimeout(f.activeAreaEvent);f.activeAreaEvent=0;
}if(l<0){return;}if(i.owner.currentAction||l){f.activeAreaEvent=window.setTimeout((function(){return function(){h(0,i,j);
};}(i)),l||100);}else{k(i.areaId);}}this.image=e;this.imgCssText=e.style.cssText||null;
this.initializeDefaults();this.configureOptions(g);this.mousedown=function(i){if(!a.mapster.hasCanvas){this.blur();
}i.preventDefault();};this.mouseover=function(k){var j=f.getAllDataForArea(this),i=j.length?j[0]:null;
if(!i||i.isNotRendered()||i.owner.currentAction){return;}if(f.currentAreaId===i.areaId){return;
}if(f.highlightId!==i.areaId){f.clearEffects();i.highlight();if(f.options.showToolTip){a.each(j,function(m,l){if(l.effectiveOptions().toolTip){l.showToolTip();
}});}}f.currentAreaId=i.areaId;if(a.isFunction(f.options.onMouseover)){f.options.onMouseover.call(this,{e:k,options:i.effectiveOptions(),key:i.key,selected:i.isSelected()});
}};this.mouseout=function(j){var k,i=f.getDataForArea(this),l=f.options;if(f.currentAreaId<0||!i){return;
}k=f.getDataForArea(j.relatedTarget);if(k===i){return;}f.currentAreaId=-1;i.area=null;
h(l.mouseoutDelay,i,f.clearEffects);if(a.isFunction(l.onMouseout)){l.onMouseout.call(this,{e:j,options:l,key:i.key,selected:i.isSelected()});
}};this.clearEffects=function(){var i=f.options;f.ensureNoHighlight();if(i.toolTipClose&&a.inArray("area-mouseout",i.toolTipClose)>=0&&f.activeToolTip){f.clearToolTip();
}};this.click=function(m){var r,n,o,p,j,k,s,t=this,i=f.getDataForArea(this),q=f.options;
function l(u){var v;j=(u.isSelectable()&&(u.isDeselectable()||!u.isSelected()));if(j){p=!u.isSelected();
}else{p=u.isSelected();}o=b.getBoundList(q,u.key);if(a.isFunction(q.onClick)){k=q.onClick.call(t,{e:m,listTarget:o,key:u.key,selected:p});
if(d.isBool(k)){if(!k){return false;}s=a(u.area).attr("href");if(s!=="#"){window.location.href=s;
return false;}}}if(j){r=u.toggleSelection();}if(q.boundList&&q.boundList.length>0){b.setBoundListProperties(q,o,u.isSelected());
}v=u.effectiveOptions();if(v.includeKeys){n=d.split(v.includeKeys);a.each(n,function(y,x){var w=f.getDataForKey(x.toString());
if(!w.options.isMask){l(w);}});}}f.mousedown.call(this,m);if(q.clickNavigate&&i.href){window.location.href=i.href;
return;}if(i&&!i.owner.currentAction){q=f.options;l(i);}};this.graphics=new b.Graphics(this);
};c=b.MapData.prototype;c.configureOptions=function(e){this.area_options=d.updateProps({},b.area_defaults,e);
this.options=d.updateProps({},b.defaults,e);this.bindTries=this.options.configTimeout/200;
};c.initializeDefaults=function(){a.extend(this,{images:[],imageSources:[],imageStatus:[],altImagesXref:{},map:null,base_canvas:null,overlay_canvas:null,imagesLoaded:false,complete:false,commands:[],data:[],mapAreas:[],_xref:{},highlightId:-1,currentAreaId:-1,scaleInfo:null,index:-1,activeAreaEvent:null});
};c.isActive=function(){return !this.complete||this.currentAction;};c.state=function(){return{complete:this.complete,resizing:this.currentAction==="resizing",zoomed:this.zoomed,zoomedArea:this.zoomedArea,scaleInfo:this.scaleInfo};
};c.isReadyToBind=function(){return this.imagesLoaded&&(!this.options.safeLoad||b.windowLoaded);
};c.addImage=function(h,l,e){var g,k,j=this,f=function(n){return a.inArray(n,j.images);
},i=function(){var n=f(this);if(n>=0){j.imageStatus[n]=true;if(a.inArray(false,j.imageStatus)<0&&(!j.options.safeLoad||b.windowLoaded)){j.initialize();
}}},m=function(n){var o=j.images.push(n)-1;j.imageSources[o]=k;j.imageStatus[o]=false;
if(e){j.altImagesXref[e]=o;}};if(!h&&!l){return;}g=h;k=l||a(g).attr("src");if(!k){throw ("Missing image source");
}if(!g){g=a('<img class="mapster_el" />').hide()[0];a("body").append(g);m(g);a(g).bind("onload",i).bind("onerror",function(n){j.imageLoadError.call(j,n);
});a(g).attr("src",k);}else{m(g);}};c.isImageLoaded=function(f){var h,e,g=this;if(g.imageStatus[f]){return true;
}e=g.images[f];if(typeof e.complete!=="undefined"){h=e.complete;}else{h=!!d.imgWidth(e);
}g.imageStatus[f]=h;return h;};c.bindImages=function(f,e){var g,j=this,h=true,k=j.options,l=function(){j.bindImages.call(j,false,e);
};if(f){j.complete=false;j.triesLeft=j.bindTries;j.imagesLoaded=false;if(j.images.length>2){j.images=j.images.slice(0,2);
j.imageSources=j.imageSources.slice(0,2);j.imageStatus=j.imageStatus.slice(0,2);j.altImagesXref={};
}j.altImagesXref={};if(j.images.length===0){j.addImage(j.image);j.addImage(null,j.image.src);
}if(a.mapster.hasCanvas){j.addImage(null,k.render_highlight.altImage||k.altImage,"highlight");
j.addImage(null,k.render_select.altImage||k.altImage,"select");}}if(j.imagesLoaded){return;
}g=j.images.length;while(g-->0){if(!j.isImageLoaded(g)){h=false;break;}}j.imagesLoaded=h;
if(j.isReadyToBind()){if(e){e();}else{j.initialize();}}else{if(j.triesLeft-->0){j.imgTimeout=window.setTimeout(l,200);
}else{j.imageLoadError.call(j);}}};c.imageLoadError=function(f){clearTimeout(this.imgTimeout);
this.triesLeft=0;var g=f?"The image "+f.target.src+" failed to load.":"The images never seemed to finish loading. You may just need to increase the configTimeout if images could take a long time to load.";
throw g;};c.altImage=function(e){return this.images[this.altImagesXref[e]];};c.wrapId=function(){return"mapster_wrap_"+this.index;
};c._idFromKey=function(e){return typeof e==="string"&&this._xref.hasOwnProperty(e)?this._xref[e]:-1;
};c.getSelected=function(){var e="";a.each(this.data,function(g,f){if(f.isSelected()){e+=(e?",":"")+this.key;
}});return e;};c.getAllDataForArea=function(f,g){var h,e,l,k=this,j=a(f).filter("area").attr(k.options.mapKey);
if(j){l=[];j=d.split(j);for(h=0;h<(g||j.length);h++){e=k.data[k._idFromKey(j[h])];
e.area=f.length?f[0]:f;l.push(e);}}return l;};c.getDataForArea=function(f){var e=this.getAllDataForArea(f,1);
return e?e[0]||null:null;};c.getDataForKey=function(e){return this.data[this._idFromKey(e)];
};c.getKeysForGroup=function(f){var e=this.getDataForKey(f);return !e?"":e.isPrimary?e.key:this.getPrimaryKeysForMapAreas(e.areas()).join(",");
};c.getPrimaryKeysForMapAreas=function(e){var f=[];a.each(e,function(h,g){if(a.inArray(g.keys[0],f)<0){f.push(g.keys[0]);
}});return f;};c.getData=function(e){if(typeof e==="string"){return this.getDataForKey(e);
}else{if(e&&e.mapster||d.isElement(e)){return this.getDataForArea(e);}else{return null;
}}};c.ensureNoHighlight=function(){var e;if(this.highlightId>=0){this.graphics.clearHighlight();
e=this.data[this.highlightId];e.changeState("highlight",false);this.setHighlightId(-1);
}};c.setHighlightId=function(e){this.highlightId=e;};c.clearSelections=function(){a.each(this.data,function(g,f){if(f.selected){f.removeSelection(true);
}});this.removeSelectionFinish();};c.setAreaOptions=function(f){var j,g,e,h=f||{};
for(j=h.length-1;j>=0;j--){g=h[j];e=this.getDataForKey(g.key);if(e){d.updateProps(e.options,g);
if(d.isBool(g.selected)){e.selected=g.selected;}}}};c.drawSelections=function(g){var e,f=d.asArray(g);
for(e=f.length-1;e>=0;e--){this.data[f[e]].drawSelection();}};c.redrawSelections=function(){a.each(this.data,function(g,f){if(f.isSelectedOrStatic()){f.drawSelection();
}});};c.initialize=function(){var j,e,m,s,n,f,g,p,h,q,r,o,k=this,l=k.options;if(k.complete){return;
}h=a(k.image);n=h.parent().attr("id");if(n&&n.length>=12&&n.substring(0,12)==="mapster_wrap"){s=h.parent();
s.attr("id",k.wrapId());}else{s=a('<div id="'+k.wrapId()+'"></div>');if(l.wrapClass){if(l.wrapClass===true){s.addClass(h[0].className);
}else{s.addClass(l.wrapClass);}}}k.wrapper=s;k.scaleInfo=o=d.scaleMap(k.images[0],k.images[1],l.scaleMap);
e=k.graphics.createVisibleCanvas(k);m=k.graphics.createVisibleCanvas(k);k.base_canvas=e;
k.overlay_canvas=m;j=a(k.images[1]).addClass("mapster_el").addClass(k.images[0].className).attr({id:null,usemap:null});
p=d.size(k.images[0]);if(p.complete){j.css({width:p.width,height:p.height});}k.buildDataset();
f={display:"block",position:"relative",padding:0,width:o.width,height:o.height};if(l.wrapCss){a.extend(f,l.wrapCss);
}if(h.parent()[0]!==k.wrapper[0]){h.before(k.wrapper);}s.css(f);a(k.images.slice(2)).hide();
for(g=1;g<k.images.length;g++){s.append(k.images[g]);}s.append(e).append(m).append(h.css(b.canvas_style));
d.setOpacity(k.images[0],0);a(k.images[1]).show();d.setOpacity(k.images[1],1);if(l.isSelectable&&l.onGetList){r=k.data.slice(0);
if(l.sortList){if(l.sortList==="desc"){q=function(i,t){return i===t?0:(i>t?-1:1);
};}else{q=function(i,t){return i===t?0:(i<t?-1:1);};}r.sort(function(i,t){i=i.value;
t=t.value;return q(i,t);});}k.options.boundList=l.onGetList.call(k.image,r);}k.complete=true;
k.processCommandQueue();if(l.onConfigured&&typeof l.onConfigured==="function"){l.onConfigured.call(h,true);
}};c.buildDataset=function(w){var x,i,p,h,e,g,k,s,q,r,t,n,l,o,u=this,v=u.options,m;
function f(y,z){var j=new b.AreaData(u,y,z);j.areaId=u._xref[y]=u.data.push(j)-1;
return j.areaId;}u._xref={};u.data=[];if(!w){u.mapAreas=[];}m=!v.mapKey;if(m){v.mapKey="data-mapster-key";
}x=(a.browser.msie&&a.browser.version<=7)?"area":(m?"area[coords]":"area["+v.mapKey+"]");
i=a(u.map).find(x).unbind(".mapster");for(t=0;t<i.length;t++){h=0;g=i[t];e=a(g);if(!g.coords){continue;
}if(m){k=String(t);e.attr("data-mapster-key",k);}else{k=g.getAttribute(v.mapKey);
}if(w){s=u.mapAreas[e.data("mapster")-1];s.configure(k);}else{s=new b.MapArea(u,g,k);
u.mapAreas.push(s);}r=s.keys;for(p=r.length-1;p>=0;p--){q=r[p];if(v.mapValue){n=e.attr(v.mapValue);
}if(m){h=f(u.data.length,n);l=u.data[h];l.key=q=h.toString();}else{h=u._xref[q];if(h>=0){l=u.data[h];
if(n&&!u.data[h].value){l.value=n;}}else{h=f(q,n);l=u.data[h];l.isPrimary=p===0;}}s.areaDataXref.push(h);
l.areasXref.push(t);}o=e.attr("href");if(o&&o!=="#"&&!l.href){l.href=o;}if(!s.nohref){e.bind("mouseover.mapster",u.mouseover).bind("mouseout.mapster",u.mouseout).bind("click.mapster",u.click).bind("mousedown.mapster",u.mousedown);
}e.data("mapster",t+1);}u.setAreaOptions(v.areas);u.redrawSelections();};c.processCommandQueue=function(){var e,f=this;
while(!f.currentAction&&f.commands.length){e=f.commands[0];f.commands.splice(0,1);
b.impl[e.command].apply(e.that,e.args);}};c.clearEvents=function(){a(this.map).find("area").unbind(".mapster");
a(this.images).unbind(".mapster");};c._clearCanvases=function(e){if(!e){a(this.base_canvas).remove();
}a(this.overlay_canvas).remove();};c.clearMapData=function(f){var e=this;this._clearCanvases(f);
a.each(this.data,function(h,g){g.reset();});this.data=null;if(!f){this.image.style.cssText=this.imgCssText;
a(this.wrapper).before(this.image).remove();}a.each(this.images,function(h,g){if(e.images[h]!==g.image){e.images[h]=null;
}});e.images=[];this.image=null;d.ifFunction(this.clearToolTip,this);};c.removeSelectionFinish=function(){var e=this.graphics;
e.refreshSelections();e.clearHighlight();};}(jQuery));